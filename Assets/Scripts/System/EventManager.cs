using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class EventManager
{

    /*--------??????????---------*/

    static EventManager eventManager = new EventManager();
    private EventManager() { }
    public static EventManager Instance
    {
        get
        {
            return eventManager;
        }
    }
    public void ReducePlayerEnergy(int amount)
    {
        // 假设 Player_Controller 是单例模式
        if (Player_Controller.Instance != null)
        {
            Player_Controller.Instance.ReduceEnergy(amount);
        }
        else
        {
            Debug.LogError("Player_Controller instance is not available!");
        }
    }
    //??????????????????б?
    public delegate void EventDelegate(object[] args);
    //????????????????ж?????????????????????????????ID
    private Dictionary<string, Dictionary<int, EventDelegate>> eventListeners = new Dictionary<string, Dictionary<int, EventDelegate>>();



    /*-------???????????---------*/


    //??????????(?????????????????????????????????ID????????)
    public void Regist(string eventName, EventDelegate handler)
    {
        //?????????????????????
        if (handler == null)
        {
            return;
        }

        //??????????в???????eventName???????????????????????????????????
        if (!eventListeners.ContainsKey(eventName))
        {
            eventListeners.Add(eventName, new Dictionary<int, EventDelegate>());


        }

        //???eventName????????,????????????????
        var handlerDic = eventListeners[eventName];
        //???????????????????
        var handlerHash = handler.GetHashCode();

        //???????????????????а???????????????????
        if (handlerDic.ContainsKey(handlerHash))
        {
            handlerDic.Remove(handlerHash);
        }

        //??eventName????????????????????????????
        eventListeners[eventName].Add(handler.GetHashCode(), handler);
    }

    // ?????????????????????????????????????????????????
    public void UnRegist(string eventName, EventDelegate handLer)
    {
        //???????????????????????к???????
        if (handLer == null)
        {
            return;
        }

        //??????????а?????eventName???ID,??????ü??ж????????е????????????
        if (eventListeners.ContainsKey(eventName))
        {
            eventListeners[eventName].Remove(handLer.GetHashCode());
            //??????????eventName????????????????????????????ü???? 
            if (eventListeners[eventName] == null || eventListeners[eventName].Count == 0)
            {
                eventListeners.Remove(eventName);
            }
        }
    }


    // ?????????????ID?????????????????????????????????
    public void DispatchEvent(string eventName, params object[] objs)
    {
        // ???????eventName???ID
        if (eventListeners.ContainsKey(eventName))
        {
            //???eventName?????????????????
            var handlerDic = eventListeners[eventName];
            if (handlerDic != null && handlerDic.Count > 0)
            {
                var dic = new Dictionary<int, EventDelegate>(handlerDic);
                //?????eventName?????????????н??б????????????
                foreach (var f in dic.Values)
                {
                    try
                    {
                        //??????е???????????EventDelegate(object[] args)
                        f(objs);
                    }
                    catch (System.Exception)
                    {

                        throw;
                    }
                }
            }
        }
    }


    // ??????????????????????????????????????????????????????????????????????????
    public void ClearEvents(string eventName)
    {
        //??????????а???eventName?е???????????????????????????????
        if (eventListeners.ContainsKey(eventName))
        {
            eventListeners.Remove(eventName);
        }
    }
}


